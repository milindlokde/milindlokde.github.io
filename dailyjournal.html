<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Reflective Journal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons (for JavaScript use) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* Style for the fixed header on mobile */
        #journal-header {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Modal backdrop styles (Added for Export/Import Modals) */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            border-radius: 1rem;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Modal for Export/Backup -->
    <div id="export-modal" class="modal-backdrop hidden" onclick="closeModal('export-modal')">
        <div class="modal-content p-6" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="download-cloud" class="w-6 h-6 mr-2 text-green-600"></i>
                Export All Data (Backup)
            </h2>
            <p class="text-gray-600 mb-6">
                This will download **all** your journal entries from LocalStorage as a single JSON file. Keep this file safe for restoring later.
            </p>
            <div id="export-status" class="text-sm font-medium text-red-500 mb-4"></div>
            <button id="confirm-export-btn" class="w-full px-4 py-3 rounded-xl text-lg font-semibold transition-all duration-200 shadow-md bg-green-600 hover:bg-green-700 text-white active:ring-4 active:ring-green-300">
                Start Full Export
            </button>
        </div>
    </div>

    <!-- Modal for Import/Restore -->
    <div id="import-modal" class="modal-backdrop hidden" onclick="closeModal('import-modal')">
        <div class="modal-content p-6" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="upload-cloud" class="w-6 h-6 mr-2 text-indigo-600"></i>
                Import Data (Restore)
            </h2>
            <p class="text-gray-600 mb-6">
                Uploading a file will **merge** new entries and **overwrite** existing entries with the same dates in your LocalStorage.
            </p>
            <input type="file" id="import-file-input" accept=".json" class="w-full p-2 border border-gray-300 rounded-lg mb-4 text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
            <div id="import-status" class="text-sm font-medium text-red-500 mb-4"></div>
            <button id="confirm-import-btn" class="w-full px-4 py-3 rounded-xl text-lg font-semibold transition-all duration-200 shadow-md bg-indigo-600 hover:bg-indigo-700 text-white active:ring-4 active:ring-indigo-300">
                Confirm Import and Merge
            </button>
        </div>
    </div>

    <div id="journal-header" class="sticky top-0 bg-white z-10 py-4 border-b border-gray-100">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl font-extrabold text-gray-900 flex items-center mb-3 md:mb-0">
                    <i data-lucide="calendar-days" class="w-7 h-7 mr-3 text-indigo-600"></i>
                    Daily Reflection
                </h1>
                
                <div class="flex items-center space-x-2 w-full md:w-auto mb-3 md:mb-0">
                    <!-- NEW: Import/Restore Button -->
                    <button id="open-import-modal-btn" class="flex items-center justify-center space-x-2 px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 shadow-md bg-indigo-200 hover:bg-indigo-300 text-indigo-800 active:ring-4 active:ring-indigo-100">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                        Import
                    </button>
                    <!-- NEW: Export/Backup Button -->
                    <button id="open-export-modal-btn" class="flex items-center justify-center space-x-2 px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 shadow-md bg-gray-700 hover:bg-gray-800 text-white active:ring-4 active:ring-gray-300">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export All
                    </button>
                </div>

                <div class="flex items-center space-x-2 justify-center w-full md:w-auto">
                    <button id="prev-day" class="flex items-center justify-center p-3 text-sm font-medium rounded-lg transition-all duration-200 bg-indigo-500 hover:bg-indigo-600 text-white active:ring-4 active:ring-indigo-300">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <div id="date-display" class="flex items-center space-x-2 bg-indigo-50 p-2 rounded-xl text-indigo-700 text-lg font-semibold shadow-inner min-w-[180px] justify-center">
                        <i data-lucide="calendar" class="w-5 h-5"></i>
                        <span id="current-date-text"></span>
                    </div>
                    <button id="next-day" class="flex items-center justify-center p-3 text-sm font-medium rounded-lg transition-all duration-200 bg-indigo-500 hover:bg-indigo-600 text-white active:ring-4 active:ring-indigo-300">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                    <button id="go-today" class="flex items-center justify-center space-x-2 px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 shadow-md bg-gray-700 hover:bg-gray-800 text-white active:ring-4 active:ring-gray-300">
                        Today
                    </button>
                </div>
            </div>
        </div>
    </div>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Column 1 (Flows 1-3 on mobile, 2/3 width on desktop) -->
            <div class="lg:col-span-2 space-y-6">

                <!-- 1. Gratitude -->
                <div id="gratitude-card" class="p-4 md:p-5 bg-white rounded-2xl shadow-xl border border-gray-100 flex flex-col">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800 flex items-center">
                        <i data-lucide="heart" class="w-6 h-6 mr-3 text-indigo-500"></i>
                        Gratitude (3 Things)
                    </h2>
                    <textarea id="gratitude-input" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition-colors duration-150 resize-none text-sm font-medium leading-relaxed flex-1 min-h-0"
                        placeholder="What are three things you are genuinely grateful for today? Focus on small, specific details. (Aim for ~20 sentences)"></textarea>
                </div>

                <!-- 2. Expressing Emotions -->
                <div id="emotions-card" class="p-4 md:p-5 bg-white rounded-2xl shadow-xl border border-gray-100 flex flex-col">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800 flex items-center">
                        <i data-lucide="smile" class="w-6 h-6 mr-3 text-indigo-500"></i>
                        Expressing Emotions
                    </h2>
                    <textarea id="emotions-input" rows="15" class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition-colors duration-150 resize-none text-sm font-medium leading-relaxed flex-1 min-h-0"
                        placeholder="How do you truly feel right now? Describe the texture and complexity of your emotions without judgment. (Aim for ~50 sentences)"></textarea>
                </div>

                <!-- 3. 10 Solutions for Major Concerns -->
                <div id="solutions-card" class="p-4 md:p-5 bg-white rounded-2xl shadow-xl border border-gray-100 flex flex-col">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800 flex items-center">
                        <i data-lucide="zap" class="w-6 h-6 mr-3 text-indigo-500"></i>
                        10 Solutions for Major Concerns
                    </h2>
                    <p class="text-sm text-gray-500 italic mb-4">Identify 10 actionable steps for your biggest concerns. Use the pre-filled examples to inspire concrete action.</p>
                    <div id="solutions-list" class="space-y-3">
                        <!-- Solutions will be injected here by JS -->
                    </div>
                </div>
            </div>

            <!-- Column 2 (Flows 4-5 on mobile, 1/3 width on desktop) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 4. Things to Do (To-Do List) -->
                <div id="todos-card" class="p-4 md:p-5 bg-white rounded-2xl shadow-xl border border-gray-100 flex flex-col">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800 flex items-center">
                        <i data-lucide="list-checks" class="w-6 h-6 mr-3 text-indigo-500"></i>
                        Things to Do
                    </h2>
                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="new-todo-input" placeholder="Add a new task..." class="flex-grow p-3 border border-gray-300 rounded-l-lg text-sm focus:border-indigo-500 transition-colors" />
                        <button id="add-todo-btn" class="px-3 py-2 rounded-l-none text-sm font-medium transition-all duration-200 bg-indigo-600 hover:bg-indigo-700 text-white active:ring-4 active:ring-indigo-300 rounded-lg shadow-md">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <ul id="todo-list-container" class="space-y-2">
                        <!-- Todos will be injected here by JS -->
                    </ul>
                </div>

                <!-- 5. Affirmations -->
                <div id="affirmations-card" class="p-4 md:p-5 bg-white rounded-2xl shadow-xl border border-gray-100 flex flex-col">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800 flex items-center">
                        <i data-lucide="check" class="w-6 h-6 mr-3 text-indigo-500"></i>
                        Affirmations
                    </h2>
                    <textarea id="affirmations-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition-colors duration-150 resize-none text-sm font-medium leading-relaxed flex-1 min-h-0"
                        placeholder="Write empowering 'I am...' statements to reinforce a positive mindset."></textarea>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Use a simple data structure for the journal entry
        const initialEntry = {
            gratitude: '',
            emotions: '',
            solutions: [
                "1. Break down major project into 3 small steps.",
                "2. Schedule 30 minutes of deep work without distractions.",
                "3. Write down 5 alternative views on my current struggle.",
                "4. Delegate or drop one non-essential task today.",
                "5. Have a constructive, polite conversation about the issue.",
                "6. Search for an expert guide or tutorial on the specific skill I need.",
                "7. For my anxiety, try the 5-4-3-2-1 grounding technique.",
                "8. Set a hard deadline and a reward for completing it.",
                "9. Identify one person who can offer support or advice.",
                "10. Take a 15-minute walk to gain perspective."
            ],
            todos: [], // { id: timestamp, text: string, completed: boolean }
            affirmations: '',
        };

        let currentDate = new Date();
        const LOCAL_STORAGE_KEY = 'dailyJournalEntries';

        // --- Utility Functions ---

        const formatDate = (date) => date.toISOString().split('T')[0];
        const getCurrentDateKey = () => formatDate(currentDate);

        // Expose modal control functions globally
        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            // Clear status when opening modal
            const statusId = id === 'export-modal' ? 'export-status' : 'import-status';
            const statusDiv = document.getElementById(statusId);
            if(statusDiv) statusDiv.textContent = '';
        };
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            // Reset file input when closing import modal
            if (id === 'import-modal') {
                const fileInput = document.getElementById('import-file-input');
                if(fileInput) fileInput.value = '';
            }
        };

        // Utility to download JSON data
        const downloadJson = (data, filename) => {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };


        // --- Data Persistence (Local Storage) ---

        /**
         * Loads all data from local storage.
         * @returns {object} All entries indexed by date string.
         */
        const loadAllData = () => {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                return {};
            }
        };

        /**
         * Saves the current day's entry to local storage.
         */
        const saveEntry = () => {
            const dateKey = getCurrentDateKey();
            const allEntries = loadAllData();

            const currentEntry = {
                gratitude: document.getElementById('gratitude-input').value,
                emotions: document.getElementById('emotions-input').value,
                solutions: Array.from(document.querySelectorAll('#solutions-list input')).map(input => input.value),
                todos: getCurrentTodos(),
                affirmations: document.getElementById('affirmations-input').value,
            };

            // Remove empty solutions/todos to keep storage clean
            currentEntry.solutions = currentEntry.solutions.filter(s => s.trim() !== '');
            currentEntry.todos = currentEntry.todos.filter(t => t.text.trim() !== '');

            // Only save if the entry has content
            const hasContent = Object.values(currentEntry).some(val => 
                (Array.isArray(val) && val.length > 0) || 
                (typeof val === 'string' && val.trim().length > 0)
            );

            if (hasContent) {
                allEntries[dateKey] = currentEntry;
            } else {
                 // If all fields are empty, delete the entry for the current day
                delete allEntries[dateKey];
            }


            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allEntries));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                // Note: Max size exceeded is the common error here
                // We don't use alert, so just log the error.
            }
        };

        /**
         * Fetches all journal entries from LocalStorage and exports them as JSON.
         */
        const exportJournal = () => {
            const statusDiv = document.getElementById('export-status');
            statusDiv.textContent = 'Preparing data for download...';

            const allEntries = loadAllData();
            const count = Object.keys(allEntries).length;

            if (count === 0) {
                 statusDiv.textContent = "Success! No entries found to export.";
            } else {
                // Use a generic filename since there's no user ID
                const filename = `journal_backup_${formatDate(new Date())}.json`;
                downloadJson(allEntries, filename);
                statusDiv.textContent = `Success! Downloaded ${count} entries to ${filename}.`;
            }

            // Close the modal after a short delay
            setTimeout(() => closeModal('export-modal'), 2000);
        };

        /**
         * Reads and imports JSON data from a file input into LocalStorage.
         */
        const importJournal = () => {
            const fileInput = document.getElementById('import-file-input');
            const statusDiv = document.getElementById('import-status');
            const file = fileInput.files[0];

            if (!file) {
                statusDiv.textContent = "Please select a JSON backup file to import.";
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const uploadedData = JSON.parse(event.target.result);
                    
                    // Basic validation: must be a non-null object (key-value store: date -> entry)
                    if (typeof uploadedData !== 'object' || uploadedData === null || Array.isArray(uploadedData)) {
                        statusDiv.textContent = "Error: Invalid file format. Expected a JSON object with date keys.";
                        return;
                    }

                    // Perform the merge
                    const existingData = loadAllData();
                    const mergedData = { ...existingData, ...uploadedData }; // Merge/Overwrite
                    
                    // Overwrite LocalStorage
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(mergedData));

                    const importedKeys = Object.keys(uploadedData).length;
                    const totalKeys = Object.keys(mergedData).length;
                    
                    statusDiv.textContent = `Success! Merged ${importedKeys} entries. Total entries: ${totalKeys}.`;
                    loadAndRenderEntry(); // Refresh current view

                    setTimeout(() => closeModal('import-modal'), 2000);

                } catch (e) {
                    console.error("Import failed:", e);
                    statusDiv.textContent = `Error processing file: ${e.message}`;
                }
            };

            reader.onerror = function() {
                statusDiv.textContent = "Error reading the file.";
            };

            reader.readAsText(file);
        };


        // --- Data Retrieval/Rendering ---

        /**
         * Loads and renders the entry for the current date.
         */
        const loadAndRenderEntry = () => {
            const dateKey = getCurrentDateKey();
            const allEntries = loadAllData();
            const data = allEntries[dateKey];

            // Use spread operator to deeply merge initialEntry with loaded data
            const entry = data ? { ...initialEntry, ...data } : initialEntry;

            // Handle Solutions array length consistency
            if (!Array.isArray(entry.solutions) || entry.solutions.length < 10) {
                // Merge loaded solutions with placeholders to ensure 10 visible slots
                const mergedSolutions = [...(entry.solutions || [])];
                while (mergedSolutions.length < 10) {
                    mergedSolutions.push('');
                }
                entry.solutions = mergedSolutions;
            }


            // Set display values
            document.getElementById('gratitude-input').value = entry.gratitude || '';
            document.getElementById('emotions-input').value = entry.emotions || '';
            document.getElementById('affirmations-input').value = entry.affirmations || '';

            renderDateDisplay();
            renderSolutions(entry.solutions);
            renderTodos(entry.todos);

            // Re-render Lucide icons for dynamically injected elements
            lucide.createIcons();
        };

        /**
         * Updates the date navigation display.
         */
        const renderDateDisplay = () => {
            const dateText = document.getElementById('current-date-text');
            const today = formatDate(new Date());
            const currentKey = getCurrentDateKey();
            
            if (currentKey === today) {
                dateText.textContent = `Today (${currentKey})`;
                document.getElementById('go-today').disabled = true;
                document.getElementById('go-today').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                dateText.textContent = currentKey;
                document.getElementById('go-today').disabled = false;
                document.getElementById('go-today').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        // --- Dynamic Content Rendering ---

        const renderSolutions = (solutions) => {
            const container = document.getElementById('solutions-list');
            container.innerHTML = solutions.map((solution, index) => `
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-semibold w-6 h-6 flex items-center justify-center bg-indigo-100 text-indigo-700 rounded-full flex-shrink-0">
                        ${index + 1}
                    </span>
                    <input
                        type="text"
                        value="${solution.replace(/"/g, '&quot;')}"
                        onchange="saveEntry()"
                        onblur="saveEntry()"
                        placeholder="${initialEntry.solutions[index] || 'Write a solution...'}"
                        maxlength="100"
                        class="flex-grow p-2 border border-gray-200 rounded-lg text-sm focus:border-indigo-500 transition-colors"
                    />
                </div>
            `).join('');
            lucide.createIcons();
        };

        /**
         * Gets the current state of todos from the DOM.
         * @returns {Array} List of todo objects.
         */
        const getCurrentTodos = () => {
            const todoItems = document.querySelectorAll('#todo-list-container li');
            return Array.from(todoItems).map(li => ({
                id: li.dataset.id,
                text: li.querySelector('span').textContent,
                completed: li.classList.contains('line-through')
            }));
        };

        const renderTodos = (todos) => {
            const container = document.getElementById('todo-list-container');
            
            // Sort todos: incomplete first, then completed
            const sortedTodos = [...todos].sort((a, b) => {
                if (a.completed === b.completed) return 0;
                return a.completed ? 1 : -1;
            });
            
            container.innerHTML = sortedTodos.map(todo => `
                <li data-id="${todo.id}" class="flex items-center p-3 rounded-lg transition-all duration-150 ${todo.completed ? 'bg-green-50/50 line-through text-gray-500' : 'bg-gray-50 text-gray-800'}">
                    <button onclick="toggleTodo('${todo.id}')" class="mr-3 p-1 rounded-full border-2 border-indigo-400 text-indigo-500 hover:bg-indigo-100 transition-colors flex-shrink-0">
                        ${todo.completed ? '<i data-lucide="check" class="w-4 h-4"></i>' : '<div class="w-4 h-4"></div>'}
                    </button>
                    <span class="flex-grow text-sm">${todo.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
                    <button onclick="deleteTodo('${todo.id}')" class="text-red-400 hover:text-red-600 ml-3 p-1 rounded-md transition-colors flex-shrink-0">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </li>
            `).join('');

            if (sortedTodos.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 pt-2 text-sm italic">Nothing to do today!</p>';
            }

            lucide.createIcons();
        };

        // --- Event Handlers ---

        // Global functions for Todo operations
        window.toggleTodo = (id) => {
            const todos = getCurrentTodos();
            const updatedTodos = todos.map(todo =>
                todo.id === id ? { ...todo, completed: !todo.completed } : todo
            );
            renderTodos(updatedTodos);
            saveEntry();
        };

        window.deleteTodo = (id) => {
            const todos = getCurrentTodos();
            const updatedTodos = todos.filter(todo => todo.id !== id);
            renderTodos(updatedTodos);
            saveEntry();
        };

        const addTodo = () => {
            const input = document.getElementById('new-todo-input');
            const text = input.value.trim();

            if (text !== '') {
                const todos = getCurrentTodos();
                const newTodo = { id: Date.now().toString(), text: text, completed: false };
                const updatedTodos = [...todos, newTodo];
                
                renderTodos(updatedTodos);
                saveEntry();
                input.value = '';
            }
        };

        const changeDate = (days) => {
            currentDate.setDate(currentDate.getDate() + days);
            // Ensure time component is reset to prevent DST issues
            currentDate.setHours(12, 0, 0, 0); 
            loadAndRenderEntry();
        };

        const goToToday = () => {
            currentDate = new Date();
            currentDate.setHours(12, 0, 0, 0); // Normalize time
            loadAndRenderEntry();
        };


        // --- Initialization and Listeners ---

        const initApp = () => {
            // Initial load
            goToToday();

            // Setup Event Listeners
            document.getElementById('prev-day').addEventListener('click', () => changeDate(-1));
            document.getElementById('next-day').addEventListener('click', () => changeDate(1));
            document.getElementById('go-today').addEventListener('click', goToToday);

            document.getElementById('add-todo-btn').addEventListener('click', addTodo);
            document.getElementById('new-todo-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    addTodo();
                }
            });

            // NEW: Export and Import button listeners
            document.getElementById('open-export-modal-btn').addEventListener('click', () => openModal('export-modal'));
            document.getElementById('confirm-export-btn').addEventListener('click', exportJournal);
            
            document.getElementById('open-import-modal-btn').addEventListener('click', () => openModal('import-modal'));
            document.getElementById('confirm-import-btn').addEventListener('click', importJournal);


            // Debounced save for textareas
            const textInputs = ['gratitude-input', 'emotions-input', 'affirmations-input'];
            let saveTimer;
            const debouncedSave = () => {
                clearTimeout(saveTimer);
                saveTimer = setTimeout(saveEntry, 800);
            };

            textInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', debouncedSave);
                document.getElementById(id).addEventListener('blur', saveEntry); // Ensure save on blur
            });
            
            lucide.createIcons();
        };

        // Run initialization when the window loads
        window.onload = initApp;

    </script>
</body>
</html>
